<?php
/*
 -------------------------------------------------------------------------
 MyCustomView plugin for GLPI
 Copyright (C) 2023 by the MyCustomView Development Team.

 https://github.com/pluginsGLPI/mycustomview
 -------------------------------------------------------------------------

 LICENSE

 This file is part of MyCustomView.

 MyCustomView is free software; you can redistribute it and/or modify
 it under the terms of the GNU General Public License as published by
 the Free Software Foundation; either version 3 of the License, or
 (at your option) any later version.

 MyCustomView is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 GNU General Public License for more details.

 You should have received a copy of the GNU General Public License
 along with MyCustomView. If not, see <http://www.gnu.org/licenses/>.
 --------------------------------------------------------------------------
 */

if (!defined('GLPI_ROOT')) {
 die("Sorry. You can't access directly to this file");
}

class PluginMycustomviewConfig extends CommonDBTM
{

     /**
     * Set configuration infos in database
     * @global type $DB
     * @param $id
     * @param $max_filters
     */
    public function setConfiguration($users_id=null, $tableau_group = [])
    {
        global $DB;
        
        $resulttab = $DB->query("SELECT * FROM glpi_plugin_mycustomview_config WHERE users_id = $users_id;")->fetch_object();
        if(!empty($resulttab->id)){
            $DB->update(
                'glpi_plugin_mycustomview_config', [
                    'groupe_id_1' => $tableau_group['group1'],
                    'groupe_id_2' => $tableau_group['group2'],
                    'groupe_id_3' => $tableau_group['group3'],
                    'groupe_id_4' => $tableau_group['group4'],
                    'groupe_id_5' => $tableau_group['group5']
                ], [
                    'WHERE' => ['users_id' => $users_id]
                    ]
                );
            
        } 
        else {
            $DB->insert(
                'glpi_plugin_mycustomview_config', [
                    'users_id' => $users_id,
                    'groupe_id_1' => $tableau_group['group1'],
                    'groupe_id_2' => $tableau_group['group2'],
                    'groupe_id_3' => $tableau_group['group3'],
                    'groupe_id_4' => $tableau_group['group4'],
                    'groupe_id_5' => $tableau_group['group5']
                ]
            );
        }
    }

    public function showForm($users_id, $options = [] ){

        global $CFG_GLPI,$DB;

        if (!Session::haveRight("profile",1)) {
           return false;
        }

        if(isset($_POST['enregistrer'])) {
            for ($i = 1; $i <= 5; $i++) {
                if(!isset($_POST['groups'.$i]))$_POST['groups'.$i] = 0;
            }
            $tableau_group = array("group1" => $_POST['groups1'], 
                                   "group2" => $_POST['groups2'],
                                   "group3" => $_POST['groups3'],
                                   "group4" => $_POST['groups4'],
                                   "group5" => $_POST['groups5']);

            self::setConfiguration($users_id, $tableau_group);
        }
        
        if (!Session::haveRight("profile",READ)) {
            return false;
        }
   
        /*$canedit = Session::haveRight("profile", CREATE);
        $prof = new Profile();
        if ($id){
        $prof->getFromDB($id);
        }*/
        
        echo "<div align='center'>"; 
        echo "<form action='./config.form.php' method='post'>\n";
        echo "<table class='tab_cadre_fixe' style='margin: 0; margin-top: 5px;'>\n";
        echo " <tr><th colspan='2'>" .__("Affichage des groupes dans \"Ma vue groupe(s)\"", "mycustomview") . ".</th></tr>\n";

        $resulttab = $DB->query("SELECT * FROM glpi_plugin_mycustomview_config WHERE users_id = $users_id;")->fetch_object();
        for ($i = 1; $i <= 5; $i++) {
            $groups = 'groupe_id_'.$i;
            if (!empty($resulttab->$groups)){
                $groups = $resulttab->$groups;
            }else{
                $groups = 0;
            }
            echo '<br>';
            echo "<tr class='tab_bg_1'>";
            echo "<td>" . __('Affichage des groupes -> N°'.$i) . "</td>";
            echo "<td>";
            //notificationtemplates_id
            Dropdown::show('Group', [
                'name' => 'groups'.$i,
                'value' => $groups,
                'display_emptychoice' => 1,
                'specific_tags' => [],
                'itemtype' => 'Group',
                'displaywith' => [],
                'emptylabel' => "-----",
                'used' => [],
                'toadd' => [],
                'entity_restrict' => 0,
            ]); 
            echo "</td><td colspan='2'></td></tr>";
        }

        echo "</table>\n";
        if(Session::haveRight("profile", CREATE)){
            echo "<input type='submit' style='margin-top : 10px' name='enregistrer' class='submit'>";
        }
        else {
            echo "<div class='warning' style='margin-top:10px; width:70%'><i class='fa fa-exclamation-triangle fa'></i>";
            echo __("Vous n'avez pas les droits pour modifier les données de cette page.", "mycustomview");
            echo "</div>";
        }
        Html::closeForm();
        echo "</div>"; 
    }
}